name: CI/CD Pipeline

on:
  push:
    branches: [ main, dev, refactor, refactor-cicd ]
  pull_request:
    branches: [ main, dev, refactor, refactor-cicd ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - prod

permissions:
  checks: write
  contents: read
  pull-requests: write
  actions: read
  security-events: write

env:
  DOTNET_VERSION: '8.0.x'
  AZURE_FUNCTIONAPP_NAME: 'event-payment-func'
  AZURE_RESOURCE_GROUP: 'newfintech-rg'
  AZURE_LOCATION: 'eastus'
  BUILD_CONFIGURATION: 'Release'

jobs:
  # ========================================
  # CI: Build, Test, Security, Coverage, testing
  # ========================================
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Restore dependencies
      run: dotnet restore FintechProject.sln

    - name: Build solution
      run: dotnet build FintechProject.sln --configuration ${{ env.BUILD_CONFIGURATION }} --no-restore

    - name: Run unit tests with coverage
      run: |
        dotnet test test/FintechProject.Tests/FintechProject.Tests.csproj \
          --configuration ${{ env.BUILD_CONFIGURATION }} \
          --no-build \
          --verbosity normal \
          --logger "trx;LogFileName=test-results.trx" \
          --collect:"XPlat Code Coverage" \
          --results-directory ./coverage

    - name: Publish test results
      uses: dorny/test-reporter@v1
      if: always()
      with:
        name: Test Results
        path: '**/test-results.trx'
        reporter: dotnet-trx
        fail-on-error: true

    - name: Generate coverage report
      uses: danielpalme/ReportGenerator-GitHub-Action@5.2.4
      with:
        reports: 'coverage/**/coverage.cobertura.xml'
        targetdir: 'coveragereport'
        reporttypes: 'HtmlInline;Cobertura;Badges;MarkdownSummary'

    - name: Extract coverage percentage
      id: coverage
      run: |
        # Extract line coverage percentage from summary
        COVERAGE=$(grep -oP 'Line coverage: \K[0-9.]+' coveragereport/Summary.md | head -1)
        if [ -z "$COVERAGE" ]; then
          # Fallback: parse from Cobertura XML
          COVERAGE=$(python3 -c "import xml.etree.ElementTree as ET; tree=ET.parse('coveragereport/Cobertura.xml'); root=tree.getroot(); print(f'{float(root.attrib.get(\"line-rate\", 0))*100:.1f}')")
        fi
        echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
        echo "üìä Code Coverage: $COVERAGE%"

    - name: Enforce coverage threshold
      run: |
        COVERAGE=${{ steps.coverage.outputs.coverage }}
        THRESHOLD=80
        echo "üìä Current Coverage: $COVERAGE%"
        echo "üéØ Required Threshold: $THRESHOLD%"
        
        if (( $(echo "$COVERAGE < $THRESHOLD" | bc -l) )); then
          echo "‚ùå Coverage $COVERAGE% is below threshold $THRESHOLD%"
          echo "::error::Code coverage ($COVERAGE%) is below the required threshold ($THRESHOLD%)"
          exit 1
        else
          echo "‚úÖ Coverage $COVERAGE% meets threshold $THRESHOLD%"
        fi

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        files: ./coverage/**/coverage.cobertura.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false
        token: ${{ secrets.CODECOV_TOKEN }}

    - name: Publish coverage report artifact
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: coveragereport

    - name: Create coverage badge
      uses: schneegans/dynamic-badges-action@v1.7.0
      if: github.ref == 'refs/heads/main'
      continue-on-error: true
      with:
        auth: ${{ secrets.GIST_SECRET }}
        gistID: ${{ secrets.GIST_ID }}
        filename: fintech-coverage-badge.json
        label: Coverage
        message: ${{ steps.coverage.outputs.coverage }}%
        color: |
          ${{ 
            steps.coverage.outputs.coverage >= 80 && 'brightgreen' || 
            steps.coverage.outputs.coverage >= 60 && 'yellow' || 
            steps.coverage.outputs.coverage >= 40 && 'orange' || 
            'red' 
          }}

    - name: Publish Azure Functions
      run: |
        echo "üì¶ Publishing Azure Functions..."
        dotnet publish src/Functions/Functions.csproj \
          --configuration ${{ env.BUILD_CONFIGURATION }} \
          --output ./output \
          --verbosity normal
        
        echo "üìã Verifying publish output..."
        ls -la ./output
        
        echo "üîç Checking for host.json..."
        test -f ./output/host.json && echo "‚úÖ host.json found" || echo "‚ùå host.json missing"
        
        echo "üîç Checking for function assemblies..."
        test -f ./output/Functions.dll && echo "‚úÖ Functions.dll found" || echo "‚ùå Functions.dll missing"
        
        echo ""
        echo "üîç CRITICAL: Searching for function.json files..."
        find ./output -name "function.json" -type f
        
        FUNCTION_JSON_COUNT=$(find ./output -name "function.json" -type f | wc -l)
        echo "Found $FUNCTION_JSON_COUNT function.json files"
        
        if [ "$FUNCTION_JSON_COUNT" -eq 0 ]; then
          echo "‚ùå ERROR: No function.json files generated!"
          echo "This means the Functions SDK didn't generate metadata."
          exit 1
        else
          echo "‚úÖ Function metadata generated successfully"
        fi

    - name: Publish Azure Functions artifact
      uses: actions/upload-artifact@v4
      with:
        name: function-app
        path: ./output
        retention-days: 1

  # ========================================
  # CodeQL Security Analysis
  # ========================================
  codeql-analysis:
    name: CodeQL Security Scan
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    strategy:
      fail-fast: false
      matrix:
        language: [ 'csharp' ]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Initialize CodeQL
      uses: github/codeql-action/init@v3
      with:
        languages: ${{ matrix.language }}
        queries: security-extended,security-and-quality

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Build solution for CodeQL
      run: |
        dotnet restore FintechProject.sln
        dotnet build FintechProject.sln --configuration ${{ env.BUILD_CONFIGURATION }} --no-restore

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3
      with:
        category: "/language:${{matrix.language}}"

  # ========================================
  # CD: Deploy to Azure (Free/Minimal Cost)
  # ========================================
  deploy-azure:
    name: Deploy to Azure
    runs-on: ubuntu-latest
    needs: [build-and-test, codeql-analysis]
    if: (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/dev' || github.ref == 'refs/heads/refactor' || github.ref == 'refs/heads/refactor-cicd') && github.event_name == 'push'
    environment:
      name: prod
      url: https://${{ env.AZURE_FUNCTIONAPP_NAME }}.azurewebsites.net
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Azure Login
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Create Resource Group
      run: |
        az group create \
          --name ${{ env.AZURE_RESOURCE_GROUP }} \
          --location ${{ env.AZURE_LOCATION }}

    - name: Deploy Bicep Infrastructure
      id: deploy
      run: |
        DEPLOYMENT_OUTPUT=$(az deployment group create \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --template-file infra/main.bicep \
          --parameters functionAppName=${{ env.AZURE_FUNCTIONAPP_NAME }} \
          --query properties.outputs \
          --output json)
        
        SERVICE_BUS_CONNECTION=$(echo $DEPLOYMENT_OUTPUT | jq -r '.serviceBusConnectionString.value')
        echo "::add-mask::$SERVICE_BUS_CONNECTION"
        echo "serviceBusConnectionString=$SERVICE_BUS_CONNECTION" >> $GITHUB_OUTPUT

    - name: Download artifact
      uses: actions/download-artifact@v4
      with:
        name: function-app
        path: ./output

    - name: Verify downloaded artifact
      run: |
        echo "üîç Verifying downloaded artifact contents..."
        ls -la ./output
        echo ""
        echo "üìÇ Checking critical files..."
        test -f ./output/host.json && echo "‚úÖ host.json present" || echo "‚ùå host.json missing"
        test -f ./output/Functions.dll && echo "‚úÖ Functions.dll present" || echo "‚ùå Functions.dll missing"
        test -f ./output/Functions.deps.json && echo "‚úÖ Functions.deps.json present" || echo "‚ùå Functions.deps.json missing"
        test -f ./output/Functions.runtimeconfig.json && echo "‚úÖ Functions.runtimeconfig.json present" || echo "‚ùå Functions.runtimeconfig.json missing"
        echo ""
        echo "üìã All files in output directory:"
        find ./output -type f | head -20

    - name: Check Function App Configuration
      run: |
        echo "üîç Checking Function App OS and configuration..."
        
        FUNC_APP_KIND=$(az functionapp show \
          --name ${{ env.AZURE_FUNCTIONAPP_NAME }} \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --query "kind" -o tsv)
        
        echo "Function App Kind: $FUNC_APP_KIND"
        
        if [[ "$FUNC_APP_KIND" == *"linux"* ]]; then
          echo "‚úÖ Linux Function App detected"
        elif [[ "$FUNC_APP_KIND" == *"windows"* ]]; then
          echo "‚ö†Ô∏è Windows Function App detected - may need different deployment approach"
        fi

    - name: Configure Function App Settings
      run: |
        echo "‚öôÔ∏è Configuring Function App settings..."
        az functionapp config appsettings set \
          --name ${{ env.AZURE_FUNCTIONAPP_NAME }} \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --settings \
            "ServiceBusConnection=${{ steps.deploy.outputs.serviceBusConnectionString }}" \
            "FUNCTIONS_WORKER_RUNTIME=dotnet-isolated" \
            "FUNCTIONS_EXTENSION_VERSION=~4" \
            "AzureWebJobsDisableHomepage=false" \
            "WEBSITE_RUN_FROM_PACKAGE=0"
        
        echo "‚úÖ App settings configured"

    - name: Deploy to Azure Functions
      uses: Azure/functions-action@v1
      with:
        app-name: ${{ env.AZURE_FUNCTIONAPP_NAME }}
        package: ./output
        respect-funcignore: true
        scm-do-build-during-deployment: false
        enable-oryx-build: false

    - name: Restart Function App
      run: |
        echo "üîÑ Restarting function app to ensure triggers are loaded..."
        az functionapp restart \
          --name ${{ env.AZURE_FUNCTIONAPP_NAME }} \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }}
        
        echo "‚è≥ Waiting for function app to restart..."
        sleep 30

    - name: Sync Function Triggers
      run: |
        echo "üîÑ Syncing function triggers..."
        
        # Get subscription ID
        SUBSCRIPTION_ID=$(az account show --query id -o tsv)
        
        # Sync triggers
        az rest \
          --method POST \
          --uri "/subscriptions/$SUBSCRIPTION_ID/resourceGroups/${{ env.AZURE_RESOURCE_GROUP }}/providers/Microsoft.Web/sites/${{ env.AZURE_FUNCTIONAPP_NAME }}/syncfunctiontriggers?api-version=2023-01-01"
        
        echo "‚úÖ Trigger sync completed"
        
        # Wait for sync to complete
        sleep 15

    - name: Verify deployment
      run: |
        echo "üîç Verifying deployment..."
        
        # Get function app details
        FUNC_APP_URL=$(az functionapp show \
          --name ${{ env.AZURE_FUNCTIONAPP_NAME }} \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --query "defaultHostName" -o tsv)
        
        # Check function app state
        echo "üìä Function App State:"
        az functionapp show \
          --name ${{ env.AZURE_FUNCTIONAPP_NAME }} \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --query "{State:state, RuntimeVersion:siteConfig.linuxFxVersion, WorkerRuntime:siteConfig.appSettings[?name=='FUNCTIONS_WORKER_RUNTIME'].value | [0]}" \
          -o table
        
        # Check app settings
        echo ""
        echo "‚öôÔ∏è Key App Settings:"
        az functionapp config appsettings list \
          --name ${{ env.AZURE_FUNCTIONAPP_NAME }} \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --query "[?name=='FUNCTIONS_WORKER_RUNTIME' || name=='FUNCTIONS_EXTENSION_VERSION'].{Name:name, Value:value}" \
          -o table
        
        # List functions with more details
        echo ""
        echo "üìã Listing deployed functions..."
        FUNCTION_COUNT=$(az functionapp function list \
          --name ${{ env.AZURE_FUNCTIONAPP_NAME }} \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --query "length(@)" -o tsv)
        
        echo "Found $FUNCTION_COUNT function(s)"
        
        if [ "$FUNCTION_COUNT" -gt 0 ]; then
          az functionapp function list \
            --name ${{ env.AZURE_FUNCTIONAPP_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --query "[].{Name:name, Trigger:config.bindings[0].type, Status:config.disabled}" -o table
        else
          echo "‚ö†Ô∏è No functions found!"
          echo ""
          echo "üîç Checking Kudu for deployed files..."
          echo "Please manually check: https://${{ env.AZURE_FUNCTIONAPP_NAME }}.scm.azurewebsites.net/api/vfs/site/wwwroot/"
        fi
        
        echo ""
        echo "‚úÖ Verification completed"
        echo "üåê Function App: https://$FUNC_APP_URL"

    - name: Azure Logout
      if: always()
      run: az logout
