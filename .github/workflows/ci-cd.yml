name: CI/CD Pipeline

on:
  push:
    branches: [ main, test/unit-testing ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  DOTNET_VERSION: '8.0.x'
  AZURE_FUNCTIONAPP_NAME: 'event-payment-func'
  AZURE_RESOURCE_GROUP: 'fintech-rg'
  AZURE_LOCATION: 'eastus'
  BUILD_CONFIGURATION: 'Release'

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Restore dependencies
      run: dotnet restore FintechProject.sln

    - name: Build solution
      run: dotnet build FintechProject.sln --configuration ${{ env.BUILD_CONFIGURATION }} --no-restore

    - name: Run unit tests
      run: dotnet test test/FintechProject.Tests/FintechProject.Tests.csproj --configuration ${{ env.BUILD_CONFIGURATION }} --no-build --verbosity normal --logger "trx;LogFileName=test-results.trx"

    - name: Publish test results
      uses: dorny/test-reporter@v1
      if: always()
      with:
        name: Test Results
        path: '**/test-results.trx'
        reporter: dotnet-trx
        fail-on-error: true

    - name: Build Azure Functions
      run: dotnet build src/Functions/Functions.csproj --configuration ${{ env.BUILD_CONFIGURATION }} --output ./output

    - name: Publish Azure Functions artifact
      uses: actions/upload-artifact@v4
      with:
        name: function-app
        path: ./output

  deploy-infrastructure:
    name: Deploy Infrastructure
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    outputs:
      functionAppName: ${{ steps.deploy.outputs.functionAppName }}
      serviceBusConnectionString: ${{ steps.deploy.outputs.serviceBusConnectionString }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Azure Login
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Create Resource Group
      run: |
        az group create \
          --name ${{ env.AZURE_RESOURCE_GROUP }} \
          --location ${{ env.AZURE_LOCATION }}

    - name: Deploy Bicep template
      id: deploy
      run: |
        DEPLOYMENT_OUTPUT=$(az deployment group create \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --template-file infra/main.bicep \
          --parameters functionAppName=${{ env.AZURE_FUNCTIONAPP_NAME }} \
          --query properties.outputs \
          --output json)
        
        echo "Deployment output: $DEPLOYMENT_OUTPUT"
        
        SERVICE_BUS_CONNECTION=$(echo $DEPLOYMENT_OUTPUT | jq -r '.serviceBusConnectionString.value')
        echo "::add-mask::$SERVICE_BUS_CONNECTION"
        echo "serviceBusConnectionString=$SERVICE_BUS_CONNECTION" >> $GITHUB_OUTPUT
        echo "functionAppName=${{ env.AZURE_FUNCTIONAPP_NAME }}" >> $GITHUB_OUTPUT

    - name: Azure Logout
      if: always()
      run: az logout

  deploy-function-app:
    name: Deploy Function App
    runs-on: ubuntu-latest
    needs: [build-and-test, deploy-infrastructure]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Download artifact
      uses: actions/download-artifact@v4
      with:
        name: function-app
        path: ./output

    - name: Azure Login
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Configure Function App Settings
      run: |
        az functionapp config appsettings set \
          --name ${{ needs.deploy-infrastructure.outputs.functionAppName }} \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --settings \
            "ServiceBusConnection=${{ needs.deploy-infrastructure.outputs.serviceBusConnectionString }}" \
            "PostgresConnection=${{ secrets.POSTGRES_CONNECTION_STRING }}" \
            "FUNCTIONS_WORKER_RUNTIME=dotnet-isolated" \
            "AzureWebJobsStorage__accountName=${{ secrets.STORAGE_ACCOUNT_NAME }}"

    - name: Deploy to Azure Functions
      uses: Azure/functions-action@v1
      with:
        app-name: ${{ needs.deploy-infrastructure.outputs.functionAppName }}
        package: ./output

    - name: Azure Logout
      if: always()
      run: az logout
