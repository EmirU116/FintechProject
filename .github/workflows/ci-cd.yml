
name: CI/CD Pipeline

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main, dev ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - prod

permissions:
  checks: write
  contents: read
  pull-requests: write
  actions: read
  security-events: write

env:
  DOTNET_VERSION: '8.0.x'
  AZURE_FUNCTIONAPP_NAME: 'event-payment-func'
  AZURE_RESOURCE_GROUP: 'newfintech-rg'
  AZURE_LOCATION: 'eastus'
  BUILD_CONFIGURATION: 'Release'

# ================================================================
# CI: Build, Test, Coverage
# ================================================================
jobs:
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Restore dependencies
      run: dotnet restore FintechProject.sln

    - name: Build solution
      run: dotnet build FintechProject.sln --configuration ${{ env.BUILD_CONFIGURATION }} --no-restore

    - name: Run unit tests with coverage
      run: |
        dotnet test test/FintechProject.Tests/FintechProject.Tests.csproj \
          --configuration ${{ env.BUILD_CONFIGURATION }} \
          --no-build \
          --verbosity normal \
          --logger "trx;LogFileName=test-results.trx" \
          --collect:"XPlat Code Coverage" \
          --results-directory ./coverage

    - name: Publish test results
      uses: dorny/test-reporter@v1
      if: always()
      with:
        name: Test Results
        path: '**/test-results.trx'
        reporter: dotnet-trx
        fail-on-error: true

    - name: Generate coverage report
      uses: danielpalme/ReportGenerator-GitHub-Action@5.2.4
      with:
        reports: 'coverage/**/coverage.cobertura.xml'
        targetdir: 'coveragereport'
        reporttypes: 'HtmlInline;Cobertura;Badges;MarkdownSummary'

    - name: Extract coverage percentage
      id: coverage
      run: |
        COVERAGE=$(grep -oP 'Line coverage: \K[0-9.]+' coveragereport/Summary.md | head -1)
        if [ -z "$COVERAGE" ]; then
          COVERAGE=$(python3 -c "import xml.etree.ElementTree as ET; tree=ET.parse('coveragereport/Cobertura.xml'); root=tree.getroot(); print(f'{float(root.attrib.get(\"line-rate\", 0))*100:.1f}')")
        fi
        echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT

    - name: Enforce coverage threshold
      run: |
        COVERAGE=${{ steps.coverage.outputs.coverage }}
        THRESHOLD=80
        if (( $(echo "$COVERAGE < $THRESHOLD" | bc -l) )); then
          echo "::error::Coverage ($COVERAGE%) below threshold ($THRESHOLD%)"
          exit 1
        fi

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        files: ./coverage/**/coverage.cobertura.xml
        flags: unittests
        token: ${{ secrets.CODECOV_TOKEN }}

    - name: Publish coverage report artifact
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: coveragereport

    # Build & publish function app correctly
    - name: Publish Azure Functions project
      run: dotnet publish src/Functions/Functions.csproj --configuration ${{ env.BUILD_CONFIGURATION }} --output ./published

    - name: Upload function app artifact
      uses: actions/upload-artifact@v4
      with:
        name: function-app
        path: ./published


# ================================================================
# CodeQL Security Scan
# ================================================================
  codeql-analysis:
    name: CodeQL Security Scan
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    strategy:
      fail-fast: false
      matrix:
        language: [ 'csharp' ]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Initialize CodeQL
      uses: github/codeql-action/init@v3
      with:
        languages: ${{ matrix.language }}
        queries: security-extended,security-and-quality

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Build for CodeQL
      run: |
        dotnet restore FintechProject.sln
        dotnet build FintechProject.sln --configuration ${{ env.BUILD_CONFIGURATION }} --no-restore

    - name: Perform CodeQL analysis
      uses: github/codeql-action/analyze@v3
      with:
        category: "/language:${{matrix.language}}"


# ================================================================
# CD: Deploy to Azure
# ================================================================
  deploy-azure:
    name: Deploy to Azure
    runs-on: ubuntu-latest
    needs: [build-and-test, codeql-analysis]
    if: github.ref == 'refs/heads/main'
    environment:
      name: prod
      url: https://${{ env.AZURE_FUNCTIONAPP_NAME }}.azurewebsites.net

    steps:
    - uses: actions/checkout@v4

    - name: Azure Login
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Install jq
      run: sudo apt-get update && sudo apt-get install -y jq

    - name: Create Resource Group (idempotent)
      run: |
        az group create \
          --name ${{ env.AZURE_RESOURCE_GROUP }} \
          --location ${{ env.AZURE_LOCATION }} \
          --only-show-errors

    - name: Deploy Bicep Infrastructure
      id: deploy
      run: |
        RESULT=$(az deployment group create \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --template-file infra/main.bicep \
          --parameters functionAppName=${{ env.AZURE_FUNCTIONAPP_NAME }} \
          -o json)

        echo "serviceBusConnectionString=$(echo $RESULT | jq -r '.properties.outputs.serviceBusConnectionString.value')" \
          >> $GITHUB_OUTPUT

    - name: Download function artifact
      uses: actions/download-artifact@v4
      with:
        name: function-app
        path: ./published

    - name: Zip function package
      run: |
        cd published
        zip -r ../function.zip .

    - name: Deploy function ZIP to Azure
      run: |
        az functionapp deployment source config-zip \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --name ${{ env.AZURE_FUNCTIONAPP_NAME }} \
          --src function.zip

    - name: Sync Function Triggers
      run: |
        az functionapp functions sync \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --name ${{ env.AZURE_FUNCTIONAPP_NAME }}

    - name: Restart Function App
      run: |
        az functionapp restart \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --name ${{ env.AZURE_FUNCTIONAPP_NAME }}

    - name: Verify Deployment
      run: |
        echo "üåç Deployment completed"
        echo "URL: https://${{ env.AZURE_FUNCTIONAPP_NAME }}.azurewebsites.net"

    - name: Logout
      if: always()
      run: az logout